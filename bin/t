#!/bin/bash
# cSpell:words elif

if [ "$1" = "-h" ]; then
    printf ""
    printf "\033[1m  t - the smart tmux session manager\033[0m"
    printf "\033[37m  https://github.com/joshmedeski/t-smart-tmux-session-manager"
    printf ""
    printf "\033[32m  Run interactive mode"
    printf "\033[34m      t"
    printf ""
    printf "\033[32m  Go to session"
    printf "\033[34m      t {name}"
    printf ""
elif [ $# -eq 0 ]; then
    if [ "$TMUX" = "" ]; then
        ZOXIDE_RESULT=$(zoxide query -l | fzf --reverse --border-label ' t - smart tmux session manager ')
    else
        ZOXIDE_RESULT=$(zoxide query -l | fzf-tmux -p --reverse --border-label ' t - smart tmux session manager ')
    fi
else
    ZOXIDE_RESULT=$(zoxide query "$1")
fi

if [ "$ZOXIDE_RESULT" = "" ]; then
    exit 0
fi

FOLDER=$(basename "$ZOXIDE_RESULT")
SESSION_NAME=$(echo "$FOLDER" | tr ' ' '_' | tr '.' '_')

# lookup tmux session name
SESSION=$(tmux list-sessions | grep -F "$SESSION_NAME" | awk '{print $1}')
SESSION=${SESSION//:/}

# if not currently in tmux
if [ "$TMUX" = "" ]; then
    # tmux is not active
    if [ "$SESSION" = "" ]; then
        # session does not exist
        # jump to directory
        cd "$ZOXIDE_RESULT"
        # create session
        tmux new-session -s "$SESSION_NAME"
    else
        # session exists
        # attach to session
        tmux attach -t "$SESSION"
    fi
else
    # tmux is active
    if [ "$SESSION" = "" ]; then
        # session does not exist
        # jump to directory
        cd "$ZOXIDE_RESULT"
        # create session
        tmux new-session -d -s "$SESSION_NAME"
        # attach to session
        tmux switch-client -t "$SESSION_NAME"
    else
        # session exists
        # attach to session
        # switch to tmux session
        tmux switch-client -t "$SESSION"
    fi
fi
